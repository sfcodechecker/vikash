<!-- Inline-chat-by-intercepting-popup.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Agentforce - Inline chat via popup interception</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Host area centered below the button */
    #inline-chat-host {
      display: none;
      justify-content: center;
      padding: 16px;
      box-sizing: border-box;
    }
    #inline-chat-wrapper {
      width: min(720px, 96vw);
      height: min(700px, 80vh);
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(10,20,40,0.12);
      overflow: hidden;
      position: relative;
    }
    #inline-chat-iframe {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
    }
    #inline-chat-close {
      position: absolute;
      right: 10px;
      top: 10px;
      z-index: 10;
      background: rgba(0,0,0,0.05);
      border: none;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
    }
    /* center under button area */
    .center-container { display:flex; justify-content:center; margin-top:12px; }
  </style>
</head>
<body>
  <div style="text-align:center; padding:30px;">
    <button id="open-chat-btn" class="btn">Open Chat Inline</button>
  </div>

  <div id="inline-chat-host" class="center-container" aria-hidden="true">
    <div id="inline-chat-wrapper">
      <button id="inline-chat-close" aria-label="Close chat">✕</button>
      <iframe id="inline-chat-iframe" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
    </div>
  </div>

  <!-- Your existing init loader for bootstrap.min.js -->
  <script>
    function initEmbeddedMessaging() {
      try {
        if (window.embeddedservice_bootstrap) {
          embeddedservice_bootstrap.settings.language = 'en_US';
          embeddedservice_bootstrap.init(
            '00DgK00000DVffJ',
            'BH_Test_Messaging_Setting',
            'https://orgfarm-c20f71d007-dev-ed.develop.my.site.com/ESWBHTestMessagingSett1760515635748',
            { scrt2URL: 'https://orgfarm-c20f71d007-dev-ed.develop.my.salesforce-scrt.com' }
          );
          console.log('Embedded Messaging initialized.');
        } else {
          console.warn('embeddedservice_bootstrap not present at init time.');
        }
      } catch (err) { console.error(err); }
    }
  </script>
  <script src="https://orgfarm-c20f71d007-dev-ed.develop.my.site.com/ESWBHTestMessagingSett1760515635748/assets/js/bootstrap.min.js"
          onload="initEmbeddedMessaging()"
          onerror="console.error('Failed to load bootstrap.min.js')"></script>

  <script>
    // Safe utility to wait until util.launchChat exists
    function waitForLaunchFn({intervalMs=400,maxAttempts=30}={}) {
      return new Promise((resolve,reject)=>{
        let attempts=0;
        const t=setInterval(()=>{
          attempts++;
          const fn = window.embeddedservice_bootstrap?.utilAPI?.launchChat;
          if (typeof fn === 'function') { clearInterval(t); resolve(fn); return; }
          if (attempts>=maxAttempts) { clearInterval(t); reject(new Error('launchChat not found')); }
        }, intervalMs);
      });
    }

    // Patch window.open and capture url
    async function launchChatAndCaptureUrl() {
      // Wait until launchChat function exists (robust)
      try {
        await waitForLaunchFn();
      } catch (e) {
        console.error('launchChat not available:', e);
        throw e;
      }

      return new Promise((resolve, reject) => {
        const originalWindowOpen = window.open;
        let capturedUrl = null;
        let openCalled = false;
        let openedWindowRef = null;

        // Replace window.open temporarily
        window.open = function(url, name, specs) {
          openCalled = true;
          capturedUrl = url;
          // return a dummy window-like object to avoid errors in caller
          try { openedWindowRef = originalWindowOpen.call(window, 'about:blank', '_blank'); } catch(e) { openedWindowRef = null; }
          console.log('Captured window.open call with URL:', url);
          // return the opened window reference if available, else a minimal stub
          return openedWindowRef || { closed: false };
        };

        // Call launchChat (it may call window.open internally)
        window.embeddedservice_bootstrap.utilAPI.launchChat()
          .then(() => {
            // Small delay to ensure window.open call was made if it will be
            setTimeout(() => {
              // restore window.open
              window.open = originalWindowOpen;
              if (capturedUrl) {
                resolve({ url: capturedUrl, openedWindowRef });
              } else if (openCalled && !capturedUrl) {
                // open was called but no url captured (unlikely) -> reject
                reject(new Error('window.open called but no URL captured'));
              } else {
                // launchChat resolved without opening new window (maybe embed injected directly)
                resolve({ url: null, openedWindowRef: null });
              }
            }, 300);
          })
          .catch(err => {
            // restore and reject
            window.open = originalWindowOpen;
            reject(err);
          });
      });
    }

    // Insert captured url into iframe host and show it
    function showUrlInIframe(url) {
      if (!url) {
        console.warn('No URL to display inline.');
        return false;
      }

      const host = document.getElementById('inline-chat-host');
      const iframe = document.getElementById('inline-chat-iframe');

      // Set src (if CSP/frame-ancestors allows embedding)
      iframe.src = url;

      // Show host
      host.style.display = 'flex';
      host.setAttribute('aria-hidden','false');

      // Wire close
      document.getElementById('inline-chat-close').onclick = () => {
        // hide and optionally clear src
        host.style.display = 'none';
        host.setAttribute('aria-hidden','true');
        iframe.src = 'about:blank';
      };

      return true;
    }

    // The button click handler: launches chat and puts it inline
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById('open-chat-btn');
      btn.addEventListener('click', async function() {
        btn.disabled = true;
        try {
          const result = await launchChatAndCaptureUrl();
          // If launchChat did not open a new window but injected DOM, try to move DOM into inline host
          if (!result.url) {
            // attempt to find injected sidebar and move it (fallback)
            const injected = document.querySelector('.embeddedServiceSidebar');
            if (injected) {
              const hostBody = document.getElementById('inline-chat-wrapper');
              // If injected element is fixed, try to convert to child
              injected.classList.add('embedded-as-child'); // apply styling if needed
              // move it inside wrapper (after removing previous content)
              // but we already have the close button and wrapper; append below close button
              hostBody.appendChild(injected);
              document.getElementById('inline-chat-host').style.display='flex';
            } else {
              console.warn('No popup url and no injected sidebar found.');
            }
          } else {
            // We captured a URL — show it in iframe
            const ok = showUrlInIframe(result.url);
            if (!ok) {
              console.error('Could not render iframe. Possibly blocked by CSP/frame-ancestors.');
              alert('Unable to embed chat inline due to site restrictions (CSP).');
            }
          }
        } catch (err) {
          console.error('Failed to launch and capture chat:', err);
          alert('Chat could not be launched: ' + (err && err.message));
        } finally {
          btn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
